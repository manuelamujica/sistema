name: Recrear BD

on:
  push:
    branches:
      - main
    paths:
      - 'savyc.sql'
  workflow_dispatch:

jobs:
  update-mysql:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repo
        uses: actions/checkout@v4
        
      - name: List repository contents (again)
        run: ls -al

      - name: Print current working directory
        run: pwd
        
      - name: Configurar SSH key
        env:
          SSH_KEY: ${{ secrets.TRAYECTO3_KEY }}
        run: |
          echo "$SSH_KEY" > private_key.pem
          chmod 600 private_key.pem
          
      - name: Test SSH Connection
        env:
          SSH_HOST: ${{ secrets.TRAYECTO3_HOST }}
          SSH_USER: ${{ secrets.TRAYECTO3_USER }}
        run: |
          ssh -i private_key.pem -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "ls -l /home/brian/sql/"

      - name: Verify SQL file exists
        run: |
          ls -l *.sql
          pwd
          find . -name "*.sql" -type f

      - name: üì§ Subir archivo SQL al VPS
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          echo "üîç Buscando archivo .sql..."
          SQL_FILE_PATH=$(find . -name '*.sql' | head -n 1)
      
          if [ -z "$SQL_FILE_PATH" ]; then
            echo "‚ùå No se encontr√≥ ning√∫n archivo .sql"
            exit 1
          fi
      
          echo "üìÑ Archivo encontrado: $SQL_FILE_PATH"
          
          REMOTE_DIR="/home/$SSH_USER/sql"
      
          echo "üìÅ Verificando o creando directorio $REMOTE_DIR en VPS..."
          ssh -i private_key.pem -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "mkdir -p $REMOTE_DIR"
      
          echo "üîê Verificando permisos de $REMOTE_DIR:"
          ssh -i private_key.pem -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "ls -ld $REMOTE_DIR"
      
          echo "üì§ Subiendo archivo a VPS..."
          scp -i private_key.pem -o StrictHostKeyChecking=no "$SQL_FILE_PATH" $SSH_USER@$SSH_HOST:$REMOTE_DIR/

        
      - name: Conectar al VPS y actualizar MySQL
        env:
          SSH_HOST: ${{ secrets.TRAYECTO3_HOST }}
          SSH_USER: ${{ secrets.TRAYECTO3_USER }}
          MYSQL_USER: ${{ secrets.TRAYECTO3_MYSQL_USER }}
          MYSQL_PASS: ${{ secrets.TRAYECTO3_MYSQL_PASS }}
          MYSQL_DB: ${{ secrets.TRAYECTO3_MYSQL_DB }}
        run: |
          ssh -i private_key.pem -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
            mysql -u"$MYSQL_USER" -p"$MYSQL_PASS" -e "DROP DATABASE IF EXISTS $MYSQL_DB; CREATE DATABASE $MYSQL_DB;"
            mysql -u"$MYSQL_USER" -p"$MYSQL_PASS" "$MYSQL_DB" < /home/brian/sql/savyc.sql
          EOF

      - name: Limpiar clave privada
        run: rm -f private_key.pem
