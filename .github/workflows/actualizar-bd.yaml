name: Recrear BD

on:
  push:
    branches:
      - main
    paths:
      - 'savyc.sql'
  workflow_dispatch:

jobs:
  update-mysql:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout del repositorio
        uses: actions/checkout@v4

      - name: üìÇ Mostrar contenido del repositorio
        run: ls -al

      - name: üìç Mostrar directorio actual
        run: pwd

      - name: üîê Configurar clave SSH
        env:
          SSH_KEY: ${{ secrets.TRAYECTO3_KEY }}
        run: |
          echo "$SSH_KEY" > private_key.pem
          chmod 600 private_key.pem

      - name: üîó Probar conexi√≥n SSH al servidor
        env:
          SSH_USER: ${{ secrets.TRAYECTO3_USER }}
          SSH_HOST: ${{ secrets.TRAYECTO3_HOST }}
        run: |
          ssh -i private_key.pem -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "echo '‚úÖ Conexi√≥n SSH exitosa'"

      - name: üîç Verificar archivo SQL local
        run: |
          ls -l *.sql || { echo "‚ùå No se encontr√≥ el archivo savyc.sql"; exit 1; }

      - name: üì§ Subir archivo SQL al VPS
        env:
          SSH_USER: ${{ secrets.TRAYECTO3_USER }}
          SSH_HOST: ${{ secrets.TRAYECTO3_HOST }}
        run: |
          SQL_FILE="savyc.sql"
          REMOTE_DIR="/home/$SSH_USER/sql"

          echo "üìÅ Asegurando existencia del directorio remoto $REMOTE_DIR..."
          ssh -i private_key.pem -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "mkdir -p $REMOTE_DIR"

          echo "üì§ Subiendo $SQL_FILE al VPS..."
          scp -i private_key.pem -o StrictHostKeyChecking=no "$SQL_FILE" $SSH_USER@$SSH_HOST:$REMOTE_DIR/

      - name: üõ†Ô∏è Ejecutar script en MySQL remoto
        env:
          SSH_USER: ${{ secrets.TRAYECTO3_USER }}
          SSH_HOST: ${{ secrets.TRAYECTO3_HOST }}
          MYSQL_USER: ${{ secrets.TRAYECTO3_MYSQL_USER }}
          MYSQL_PASS: ${{ secrets.TRAYECTO3_MYSQL_PASS }}
          MYSQL_DB: ${{ secrets.TRAYECTO3_MYSQL_DB }}
        run: |
          echo "üß® Eliminando y recreando la base de datos $MYSQL_DB..."
          ssh -i private_key.pem -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
            mysql -u"$MYSQL_USER" -p"$MYSQL_PASS" -e "DROP DATABASE IF EXISTS $MYSQL_DB; CREATE DATABASE $MYSQL_DB;"
            mysql -u"$MYSQL_USER" -p"$MYSQL_PASS" "$MYSQL_DB" < /home/$SSH_USER/sql/savyc.sql
          EOF

      - name: üßπ Limpiar clave privada
        run: rm -f private_key.pem
